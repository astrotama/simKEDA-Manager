<?php
// $Id$

/**
 * Implementation of hook_perm().
 */
//onModuleCreationWizard
function penata_perm() {
    return array(
        'access penata content',
		'access laporan penata'
	);
}

/**
 * Implementation of hook_menu().
 */

function penata_menu() {

	$items['penata'] = array (
      'title' => 'Anggaran penata',
	  'description' => 'Anggaran penata',
	  'title callback' => 'penata_title_callback',	  
      'page callback' => 'penata_main',
      //'access arguments' => array ('access content'),
	  'access callback' => 'user_is_logged_in',
      'weight' => 11,
      'file' => 'penata_main.php',
      'type' => MENU_NORMAL_ITEM,
    );
	$items['penata/register'] = array (
      'title' => 'Register SP2D Kegiatan',
	  'description' => 'Anggaran penata usahaan',
	  'title callback' => 'penata_title_callback',	  
      'page callback' => 'penata_keg_main',
      //'access arguments' => array ('access content'),
	  'access callback' => 'user_is_logged_in',
      'weight' => 11,
      'file' => 'penata_keg_main.php',
      'type' => MENU_NORMAL_ITEM,
    );
	$items['penata/edit'] = array (
      'title' => 'Anggaran penata usahaan SKPD',
	  'description' => 'Anggaran penata usahaan',
	  'title callback' => 'penata_title_callback',	  
      'page callback' => 'penata_edit_main',
      //'access arguments' => array ('access content'),
	  'access callback' => 'user_is_logged_in',
      'weight' => 11,
      'file' => 'penata_edit_main.php',
      'type' => MENU_NORMAL_ITEM,
    );
	

    return $items;
}


function penata_title_callback() {
    return t('Penatausahaan');
}


function penata_block_info() {
  // Many options are defined in hook_block_info():
  $blocks['register_sp2d_kegiatan'] = array(
    // info: The name of the block.
    'info' => t('Register SP2D Kegiatan'),
    // Block caching options (per role, per user, etc.)
    // DRUPAL_CACHE_PER_ROLE is the default.
    'cache' => DRUPAL_CACHE_PER_ROLE,
  );

  /*
  // This sample shows how to provide default settings. In this case we'll
  // enable the block in the first sidebar and make it visible only on
  // 'node/*' pages. See the hook_block_info() documentation for these.
  $blocks['example_empty'] = array(
    'info' => t('Example: empty block'),
    'status' => TRUE,
    'region' => 'sidebar_first',
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'node/*',
  );
  */

  return $blocks;
}

function penata_block_view($delta = '') {
  // The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'register_sp2d_kegiatan':
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation. The title configured
      // for the block using Drupal UI supercedes this one.
      $block['subject'] = t('Register SP2D Kegiatan');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = block_penata_contents($delta);
      break;

    case 'example_empty':
      $block['subject'] = t('Title of second block (example_empty)');
      $block['content'] = block_penata_contents($delta);
      break;

  }
  return $block;
}

function block_penata_contents($which_block) {
  switch ($which_block) {
    case 'register_sp2d_kegiatan':
      // Modules would typically perform some database queries to fetch the
      // content for their blocks. Here, we'll just use the variable set in the
      // block configuration or, if none has set, a default value.
      // Block content can be returned in two formats: renderable arrays
      // (as here) are preferred though a simple string will work as well.
      // Block content created through the UI defaults to a string.
      $result = array(
        '#markup' => draw_register_sp2d_kegiatan(),
      );
      return $result;

    case 'example_empty':
      // It is possible that a block not have any content, since it is
      // probably dynamically constructed. In this case, Drupal will not display
      // the block at all. This block will not be displayed.
      return;
  }
} 

function draw_register_sp2d_kegiatan() {

//$tahun = 2015;		//arg(2);
//$kodekeg = '{1236B31F-3D17-4878-81E3-F4027F67E355}';		//arg(3);

$tahun = arg(2);
$kodekeg = arg(3);

$arr_anggaran = array();
$arr_sp2d = array();

$anggaran = 0;
$query = db_select('kegiatan', 'k');
$query->fields('k', array('anggaran2'));
$query->condition('kodekeg', $kodekeg, '=');
$results = $query->execute();
foreach ($results as $datas) {
	$anggaran = $datas->anggaran2;
}

$i = 0;
$kum = 0;
for ($bulan=1; $bulan<=12; $bulan++){
	//$arr_bulan[$i] = $bulan;
	
	$val = 0;
	
	$query = db_select('dokumen', 'd');
	$query->fields('d', array('bulan'));
	$query->addExpression('SUM(jumlah)', 'jmlsp2d');
	$query->condition('kodekeg', $kodekeg, '=');
	$query->condition('bulan', $bulan, '=');
	$results = $query->execute();
	foreach ($results as $datas) {
		
		//$arr_sp2d[$i]= $datas->jmlsp2d;
		$val = $datas->jmlsp2d;
	}	
	//print  '<p>' . $bulan . '</p>' ;
	//print  '<p>' . $val . '</p>' ;
	
	$kum = $kum + (real) $val;
	$arr_sp2d[$i]= array((int)$bulan, (real)$kum);
	$arr_anggaran[$i] = array((int)$bulan, (real)$anggaran);;
	
	$i++;
}


$chart = array(
    '#type' => 'chart',
    '#chart_type' => 'line',
    '#chart_library' => 'highcharts', // Allowed values: 'google' or 'highcharts'
    '#title' => t('Rincian Pengajuan SP2D'),
  );
  $chart['anggaran'] = array(
    '#type' => 'chart_data',
    '#title' => t('Anggaran'),
    '#data' => $arr_anggaran,
	
  );
  $chart['sp2d'] = array(
    '#type' => 'chart_data',
    '#title' => t('SP2D'),
    '#data' => $arr_sp2d,
	
  );

  $chart_register['register_sp2d_kegiatan'] = $chart;

  return drupal_render($chart_register);

}
 
function penata_cron() {

}

